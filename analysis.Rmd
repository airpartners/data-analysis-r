---
title: "2_28-3_13_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Set up libraries

```{r echo=FALSE}
library(ggplot2)
library(sys)
```

## Load CPC data

```{r}
# Before running this, add a .Renviron file to the project directory and add the line data_filename="<path to the .csv containing the data>"
airdata=read.csv(Sys.getenv("data_filename"),header=T,na.strings="?")
airdata$datetime <- as.POSIXct(airdata$timestamp, tz = "America/New_York", format = "%Y-%m-%dT%H:%M:%S", origin="1970-01-01")
purifier_start_time <- as.POSIXct(Sys.getenv("purifier_start_time"), tz = "America/New_York", format = "%Y-%m-%dT%H:%M:%S")

```


## Calculating indoor/outdoor particle ratio
```{r echo=FALSE}
indoor_data <- data.frame("concent" = double(), "datetime"=double())
outdoor_data <- data.frame("concent" = double(), "datetime"=double())

# Filter air data into indoor and outdoor rows
indoor_vals <- airdata[airdata$valve=="a",]
outdoor_vals <- airdata[airdata$valve=="b",]

# Get average + SD of each 5-min period for indoor values
running_total <- 0
num_in_group <- 0
idx <- 0
for (i in 2:length(indoor_vals$concent)-1) {
  running_total <- running_total + indoor_vals$concent[[i]]
  num_in_group <- num_in_group + 1
  
  time_diff <- unclass(indoor_vals$datetime[[i+1]]-indoor_vals$datetime[[i]])
  if (time_diff > 3) {
    indoor_data[nrow(indoor_data)+1,] = c(running_total/num_in_group, indoor_vals$datetime[[i]])
    running_total <- 0
    num_in_group <- 0
  }
}
indoor_data[nrow(indoor_data)+1,] = c(running_total/num_in_group, indoor_vals$datetime[[i]])

# Get average + SD of each 5-min period for outdoor values
running_total <- 0
num_in_group <- 0
idx <- 0
for (i in 2:length(outdoor_vals$concent)-1) {
  running_total <- running_total + outdoor_vals$concent[[i]]
  num_in_group <- num_in_group + 1
  
  time_diff <- unclass(outdoor_vals$datetime[[i+1]]-outdoor_vals$datetime[[i]])
  if (time_diff > 3) {
    outdoor_data[nrow(outdoor_data)+1,] = c(running_total/num_in_group, outdoor_vals$datetime[[i]])
    running_total <- 0
    num_in_group <- 0
  }
}
outdoor_data[nrow(outdoor_data)+1,] = c(running_total/num_in_group, outdoor_vals$datetime[[i]])
```

``` {r echo=FALSE}
# Time that the HEPA purifier was started in the classroom

# Create data frame for storing indoor/outdoor particle concentration ratio
indoor_outdoor_ratio <- data.frame("ratio" = double(), "datetime"=double())
for (i in 1:min(length(indoor_data$datetime),length(outdoor_data$datetime))) {
  if (outdoor_data$concent[[i]] > 1) {
    indoor_outdoor_ratio[nrow(indoor_outdoor_ratio)+1,] = c(indoor_data$concent[[i]]/outdoor_data$concent[[i]],indoor_data$datetime[[i]])
  }
}
indoor_outdoor_ratio$datetime <- as.POSIXct(indoor_outdoor_ratio$datetime, tz="America/New_York", origin="1970-01-01")

before_purifier_mean <- mean((indoor_outdoor_ratio[indoor_outdoor_ratio$datetime < purifier_start_time,])$ratio)
after_purifier_mean <- mean((indoor_outdoor_ratio[indoor_outdoor_ratio$datetime > purifier_start_time,])$ratio)

ggplot(indoor_outdoor_ratio, aes(x=datetime, y=ratio)) +
  geom_line() +
  geom_hline(yintercept=1, linetype="dashed", color="blue") +
  geom_hline(yintercept=before_purifier_mean, linetype="solid", color="red") +
  geom_hline(yintercept=after_purifier_mean, linetype="solid", color="green") +
  geom_vline(xintercept=purifier_start_time, linetype="dashed", color="blue") +
  ylab("indoor/outdoor ratio") +
  xlab("date/time") +
  ylim(0,2)
```

## plot indoor/outdoor averages

``` {r echo=FALSE}
ggplot(indoor_vals, aes(x=datetime, y=concent, size=1, color='blue')) +
  geom_point() + 
  geom_point(data=outdoor_vals, aes(x=datetime, y=concent, size=1, color='red')) +
  geom_point(data=indoor_data, aes(x=datetime, y=concent, size=2, color='blue')) +
  geom_point(data=outdoor_data, aes(x=datetime, y=concent, size=2, color='red'))
```